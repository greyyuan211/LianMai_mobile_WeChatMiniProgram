(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/notice/msglist"],{"34b4":function(t,e,o){"use strict";o.d(e,"b",(function(){return n})),o.d(e,"c",(function(){return s})),o.d(e,"a",(function(){return i}));var i={quiPage:function(){return Promise.all([o.e("common/vendor"),o.e("components/qui-page/qui-page")]).then(o.bind(null,"a983"))},quiAvatar:function(){return Promise.all([o.e("common/vendor"),o.e("components/qui-avatar/qui-avatar")]).then(o.bind(null,"7a5a"))},quiUparse:function(){return Promise.all([o.e("common/vendor"),o.e("components/qui-uparse/qui-uparse")]).then(o.bind(null,"11a7"))},quiIcon:function(){return o.e("components/qui-icon/qui-icon").then(o.bind(null,"d13f"))},quiEmoji:function(){return o.e("components/qui-emoji/qui-emoji").then(o.bind(null,"0380"))}},n=function(){var t=this,e=t.$createElement,o=(t._self._c,t.$u.light()),i=t.i18n.t("notice.send");t.$mp.data=Object.assign({},{$root:{g0:o,g1:i}})},s=[]},9391:function(t,e,o){"use strict";var i=o("e8bd"),n=o.n(i);n.a},a8b3:function(t,e,o){"use strict";(function(t){o("8d7e");i(o("66fd"));var e=i(o("d893"));function i(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,o("543d")["createPage"])},c081:function(t,e,o){"use strict";o.r(e);var i=o("c7b3"),n=o.n(i);for(var s in i)"default"!==s&&function(t){o.d(e,t,(function(){return i[t]}))}(s);e["default"]=n.a},c7b3:function(t,e,o){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=o("6c07"),n=o("88dc"),s=function(){o.e("components/qui-emoji/qui-emoji").then(function(){return resolve(o("0380"))}.bind(null,o)).catch(o.oe)},a={components:{quiEmoji:s},data:function(){return{username:"",scrollTop:0,old:{scrollTop:0,focus:!1},msg:"",emojiShow:!1,dialogId:0,height:0,scv:0,bottomPadding:10,pageSize:20,pageNum:1,navbarHeight:0,cursor:0,focus:!0,imgArr:[]}},computed:{currentLoginId:function(){var t=this.$store.getters["session/get"]("userId");return parseInt(t,10)},allChatRecord:function(){var t=[],e=this.$store.getters["jv/get"]("dialog_message"),o=Object.keys(e);if(e&&o.length>0)for(var n=0;n<o.length;n+=1){var s=e[o[n]];s.dialog_id.toString()===this.dialogId&&(s.time=(0,i.time2DateAndHM)(s.created_at),s.user=this.$store.getters["jv/get"]("users/".concat(s.user_id)),t.push(s))}return t},allEmoji:function(){return this.$store.getters["jv/get"]("emoji")},userInfo:function(){return this.$store.getters["jv/get"]("users/".concat(this.currentLoginId))}},watch:{allChatRecord:function(){this.scrollToBottom()}},created:function(){if(getApp()&&getApp().systemInfo&&getApp().systemInfo.screenWidth&&getApp().systemInfo.windowHeight){var e=getApp().systemInfo.screenWidth/750;this.scv=getApp().systemInfo.windowHeight/e-140}else try{getApp().systemInfo=t.getSystemInfoSync();var o=getApp().systemInfo.screenWidth/750;this.scv=getApp().systemInfo.windowHeight/o-140}catch(i){console.error("Painter get system info failed, ".concat(JSON.stringify(i)))}},onLoad:function(e){var o=this;this.navbarHeight=t.getSystemInfoSync().statusBarHeight+44;var i=e.username,n=e.dialogId;if(n&&(this.dialogId=n),i){this.username=i;var s="".concat(i," 与你对话");t.setNavigationBarTitle({title:s})}this.getChatRecord(n),Object.keys(this.allEmoji).length<1&&this.getEmoji(),t.onKeyboardHeightChange((function(t){t.height>0?o.$nextTick((function(){o.scrollTop+=t.height})):o.$nextTick((function(){o.scrollTop-=t.height}))}))},methods:{scrollToBottom:function(){var e=this;this.$nextTick((function(){t.createSelectorQuery().selectAll(".chat-box__con").boundingClientRect().exec((function(t){var o=0;t[0].forEach((function(t){o+=t.height})),o>600&&(e.scrollTop=o-658+10,e.old.scrollTop=o-658+10)}))}))},toUpper:function(){t.startPullDownRefresh(),this.pageNum+=1,this.getChatRecord(this.dialogId)},scroll:function(t){t&&t.detail&&(this.old.scrollTop=t.detail.scrollTop)},getChatRecord:function(e){if("0"!==e){t.showNavigationBarLoading();var o={"filter[dialog_id]":e||this.dialogId,include:["user","user.groups"],"page[number]":this.pageNum,"page[limit]":this.pageSize,sort:"-createdAt"};this.$store.commit("jv/clearRecords",{_jv:{type:"dialog/message"}}),this.$store.dispatch("jv/get",["dialog/message",{params:o}]).then((function(e){e&&(t.hideNavigationBarLoading(),t.stopPullDownRefresh())})).catch((function(t){console.log(t)}))}},getEmoji:function(){this.$store.dispatch("jv/get",["emoji",{}])},cursorBlur:function(e){e&&e.detail&&(this.cursor=e.detail.cursor,e.detail.value.length>450&&t.showToast({icon:"none",title:this.i18n.t("notice.contentMaxLength"),duration:2e3}))},cursorFocus:function(t){t&&(this.emojiShow=!1)},send:function(){var e=this;if(""===this.msg)t.showToast({icon:"none",title:this.i18n.t("notice.emptycontent"),duration:2e3});else if(this.msg.length>450)t.showToast({icon:"none",title:this.i18n.t("notice.contentMaxLength"),duration:2e3});else{if("0"===this.dialogId){var o={_jv:{type:"dialog"},recipient_username:this.username,message_text:this.msg};this.$store.dispatch("jv/post",o).then((function(t){t&&(e.dialogId=t._jv.id,e.getChatRecord(t._jv.id))})).catch((function(o){o&&o.data&&o.data.errors&&("content_banned"===o.data.errors[0].code&&t.showToast({icon:"none",title:e.i18n.t("core.content_banned"),duration:2e3}),"permission_denied"===o.data.errors[0].code&&t.showToast({icon:"none",title:e.i18n.t("core.permission_denied"),duration:2e3}))}))}else{var i={_jv:{type:"dialog/message"},dialog_id:this.dialogId,message_text:this.msg};this.$store.dispatch("jv/post",i).then((function(t){t&&e.scrollToBottom()})).catch((function(o){o&&o.data&&o.data.errors&&("content_banned"===o.data.errors[0].code&&t.showToast({icon:"none",title:e.i18n.t("core.content_banned"),duration:2e3}),"permission_denied"===o.data.errors[0].code&&t.showToast({icon:"none",title:e.i18n.t("core.permission_denied"),duration:2e3}))}))}this.msg="",this.emojiShow=!1}},popEmoji:function(){var t=this;this.emojiShow?(this.scrollTop=this.old.scrollTop,this.scrollToBottom(),this.bottomPadding-=204):(this.scrollTop=this.old.scrollTop,this.scrollToBottom(!0),this.bottomPadding+=204,this.$nextTick((function(){t.scrollTop+=204}))),this.emojiShow=!this.emojiShow},getEmojiClick:function(e){var o=this;this.focus=this.old.focus;var i="";i="".concat(this.msg.slice(0,this.cursor)+e+this.msg.slice(this.cursor)),this.msg=i,this.cursor+=e.length,this.$nextTick((function(){o.focus=!0,t.hideKeyboard()}))},jumpUserPage:function(e){e&&t.navigateTo({url:"/pages/profile/index?userId=".concat(e)})},sending_pictures:function(){var e=this,o=this;t.chooseImage({count:1,success:function(i){"chooseImage:ok"===i.errMsg&&i.tempFilePaths.forEach((function(i){n.http.upload("attachments",{formData:{type:4},filePath:i,name:"file"}).then((function(t){if(201===t.statusCode)if("0"===e.dialogId){var i={_jv:{type:"dialog"},recipient_username:o.username,message_text:o.msg?o.msg:"发送图片",image_url:t.data.data.attributes.url};e.$store.dispatch("jv/post",i).then((function(t){t&&(e.msg="",e.dialogId=t._jv.id,e.getChatRecord(t._jv.id))})).catch((function(t){console.log(t)}))}else{var n={_jv:{type:"dialog/message"},dialog_id:e.dialogId,message_text:e.msg?e.msg:"发送图片",image_url:t.data.data.attributes.url,attachment_id:t.data.data.id};e.$store.dispatch("jv/post",n).then((function(t){t&&(e.msg="",e.scrollToBottom())})).catch((function(t){console.log(t)}))}})).catch((function(o){o&&o.data&&o.data.errors&&("permission_denied"===o.data.errors[0].code?t.showToast({icon:"none",title:e.i18n.t("core.permission_denied"),duration:2e3}):t.showToast({icon:"none",title:"".concat(o.data.errors[0].code),duration:2e3}))}))}))}})}}};e.default=a}).call(this,o("543d")["default"])},d893:function(t,e,o){"use strict";o.r(e);var i=o("34b4"),n=o("c081");for(var s in n)"default"!==s&&function(t){o.d(e,t,(function(){return n[t]}))}(s);o("9391");var a,r=o("f0c5"),c=Object(r["a"])(n["default"],i["b"],i["c"],!1,null,"e200bcb8",null,!1,i["a"],a);e["default"]=c.exports},e8bd:function(t,e,o){}},[["a8b3","common/runtime","common/vendor"]]]);